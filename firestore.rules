
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    // Check if the user has the 'isKJ' custom claim in their auth token.
    function isKJ() {
      return isSignedIn() && request.auth.token.isKJ == true;
    }

    // Patrons
    match /patrons/{patronId} {
      allow read: if isOwner(patronId) || isKJ();
      allow create: if isOwner(patronId);
      allow update: if isOwner(patronId);
      allow delete: if false;
    }
    
    // Song Requests
    match /song_requests/{songRequestId} {
      allow read: if isSignedIn();
      // Patrons can create their own requests.
      allow create: if isOwner(request.resource.data.patronId);
      // Patrons can delete their own requests, KJs can delete any.
      allow delete: if isOwner(resource.data.patronId) || isKJ();
      // KJs can update any request (e.g., to 'playing', 'held', or 'finished').
      // Patrons can only update their own requests if they are still 'queued'.
      allow update: if isKJ() || (isOwner(resource.data.patronId) && resource.data.status == 'queued');
    }

    // Artists and Songs catalog
    match /artists/{artistId} {
      // Anyone can read the catalog.
      allow read: if true;
      // Only the KJ can write to the catalog.
      allow write: if isKJ();

      match /songs/{songId} {
          // Anyone can read songs.
          allow read: if true;
          // Only the KJ can write songs.
          allow write: if isKJ();
      }
    }
    
    // Reviews
    match /reviews/{reviewId} {
        // Anyone can read reviews.
        allow read: if true;
        // Authenticated users can create reviews.
        allow create: if isSignedIn();
        // Nobody can update or delete reviews once created.
        allow update, delete: if false; 
    }

    // Tips
    match /tips/{tipId} {
        // Only the KJ can see the list of tips.
        allow read: if isKJ();
        // Any authenticated user can create a tip.
        allow create: if isSignedIn();
        // Nobody can update or delete tips.
        allow update, delete: if false;
    }
  }
}
