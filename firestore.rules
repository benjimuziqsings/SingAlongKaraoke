
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    // Check if the user has the 'isKJ' custom claim in their auth token.
    function isKJ() {
      return isSignedIn() && request.auth.token.isKJ == true;
    }

    // Patrons
    match /patrons/{patronId} {
      // A KJ can read any patron's profile.
      // Users can read their own profile.
      allow read: if isOwner(patronId) || isKJ();
      // A user can create their own profile document.
      allow create: if isOwner(patronId);
      // A user can update their own profile document.
      allow update: if isOwner(patronId);
      // No one can delete a patron document directly for now.
      allow delete: if false;
    }
    
    // Song Requests
    match /song_requests/{songRequestId} {
      allow read: if isSignedIn();
      allow create: if isOwner(request.resource.data.patronId);
      allow delete: if isOwner(resource.data.patronId) || isKJ();
      allow update: if isKJ();
    }

    // Artists and Songs catalog
    match /artists/{artistId} {
      // Anyone can read the catalog.
      allow read: if true;
      // Only the KJ can write to the catalog.
      allow write: if isKJ();

      match /songs/{songId} {
          // Anyone can read songs.
          allow read: if true;
          // Only the KJ can write songs.
          allow write: if isKJ();
      }
    }
    
    // Reviews
    match /reviews/{reviewId} {
        // Anyone can read reviews.
        allow read: if true;
        // Authenticated users can create reviews.
        allow create: if isSignedIn();
        // Nobody can update or delete reviews once created.
        allow update, delete: if false; 
    }

    // Tips
    match /tips/{tipId} {
        // Only the KJ can see the list of tips.
        allow read: if isKJ();
        // Any authenticated user can create a tip.
        allow create: if isSignedIn();
        // Nobody can update or delete tips.
        allow update, delete: if false;
    }
  }
}

    