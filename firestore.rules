/**
 * @fileoverview Firestore Security Rules for the Karaoke Queue Management App.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for patron data (profiles, song requests, and tips).
 * Karaoke Jockey data is accessible without ownership checks but only using `get` requests.
 *
 * Data Structure:
 * - Patrons: Stored under `/patrons/{patronId}`.  `patronId` MUST match the authenticated user's UID.
 * - Song Requests: Stored under `/patrons/{patronId}/song_requests/{songRequestId}`.
 * - Tips: Stored under `/patrons/{patronId}/tips/{tipId}`.
 * - Karaoke Jockeys: Stored under `/karaoke_jockeys/{karaokeJockeyId}`.
 *
 * Key Security Decisions:
 * - Users can only access their own patron data.
 * - Listing all patrons is disallowed for privacy.
 * - Song requests and tips are only accessible by the owning patron.
 * - The exact schema of the data being written is NOT enforced to allow for rapid iteration, outside of relational integrity checks needed for authorization.
 *
 * Denormalization for Authorization:
 * - The `patronId` is used in the path and MUST match `request.auth.uid` when creating patron documents or subcollections.  This ensures that a patron can only create data associated with their own ID.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the user is signed in.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user's UID matches the provided userId.
     * @param {string} userId - The user ID to compare against the authenticated user's UID.
     * @return {bool} True if the user is signed in and the UID matches, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the user is the owner and the resource exists.
     * @param {string} userId - The user ID to compare against the authenticated user's UID.
     * @return {bool} True if the user is signed in, the UID matches, and the resource exists.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Rules for patron profiles.
     * @path /patrons/{patronId}
     * @allow (create) User 'user_abc' can create their own profile at /patrons/user_abc if authenticated as 'user_abc'.
     * @allow (get) User 'user_abc' can get their own profile at /patrons/user_abc if authenticated as 'user_abc'.
     * @allow (update) User 'user_abc' can update their own profile at /patrons/user_abc if authenticated as 'user_abc'.
     * @allow (delete) User 'user_abc' can delete their own profile at /patrons/user_abc if authenticated as 'user_abc'.
     * @deny (create) User 'user_xyz' cannot create a profile at /patrons/user_abc.
     * @deny (get) User 'user_xyz' cannot get the profile at /patrons/user_abc.
     * @deny (update) User 'user_xyz' cannot update the profile at /patrons/user_abc.
     * @deny (delete) User 'user_xyz' cannot delete the profile at /patrons/user_abc.
     * @principle Enforces document ownership for writes.
     */
    match /patrons/{patronId} {
      allow get: if isOwner(patronId);
      allow list: if false; // Listing patrons is not allowed.
      allow create: if isOwner(patronId) && request.resource.data.id == patronId;
      allow update: if isExistingOwner(patronId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(patronId);
    }

    /**
     * @description Rules for song requests submitted by patrons.
     * @path /patrons/{patronId}/song_requests/{songRequestId}
     * @allow (create) User 'user_abc' can create a song request under their profile at /patrons/user_abc/song_requests/song_request_1.
     * @allow (get) User 'user_abc' can get a song request under their profile at /patrons/user_abc/song_requests/song_request_1.
     * @allow (update) User 'user_abc' can update a song request under their profile at /patrons/user_abc/song_requests/song_request_1.
     * @allow (delete) User 'user_abc' can delete a song request under their profile at /patrons/user_abc/song_requests/song_request_1.
     * @deny (create) User 'user_xyz' cannot create a song request under 'user_abc's profile.
     * @deny (get) User 'user_xyz' cannot get a song request under 'user_abc's profile.
     * @deny (update) User 'user_xyz' cannot update a song request under 'user_abc's profile.
     * @deny (delete) User 'user_xyz' cannot delete a song request under 'user_abc's profile.
     * @principle Enforces document ownership for all operations.
     */
    match /patrons/{patronId}/song_requests/{songRequestId} {
      allow get: if isOwner(patronId);
      allow list: if isOwner(patronId);
      allow create: if isOwner(patronId) && request.resource.data.patronId == patronId;
      allow update: if isExistingOwner(patronId) && request.resource.data.patronId == resource.data.patronId;
      allow delete: if isExistingOwner(patronId);
    }

    /**
     * @description Rules for tips given by patrons.
     * @path /patrons/{patronId}/tips/{tipId}
     * @allow (create) User 'user_abc' can create a tip under their profile at /patrons/user_abc/tips/tip_1.
     * @allow (get) User 'user_abc' can get a tip under their profile at /patrons/user_abc/tips/tip_1.
     * @allow (update) User 'user_abc' can update a tip under their profile at /patrons/user_abc/tips/tip_1.
     * @allow (delete) User 'user_abc' can delete a tip under their profile at /patrons/user_abc/tips/tip_1.
     * @deny (create) User 'user_xyz' cannot create a tip under 'user_abc's profile.
     * @deny (get) User 'user_xyz' cannot get a tip under 'user_abc's profile.
     * @deny (update) User 'user_xyz' cannot update a tip under 'user_abc's profile.
     * @deny (delete) User 'user_xyz' cannot delete a tip under 'user_abc's profile.
     * @principle Enforces document ownership for all operations.
     */
    match /patrons/{patronId}/tips/{tipId} {
      allow get: if isOwner(patronId);
      allow list: if isOwner(patronId);
      allow create: if isOwner(patronId) && request.resource.data.patronId == patronId;
      allow update: if isExistingOwner(patronId) && request.resource.data.patronId == resource.data.patronId;
      allow delete: if isExistingOwner(patronId);
    }

    /**
     * @description Rules for karaoke jockey profiles.
     * @path /karaoke_jockeys/{karaokeJockeyId}
     * @allow (get) Any signed-in user can get a karaoke jockey profile.
     * @deny (create) No one can create karaoke jockey profiles through the client.
     * @deny (update) No one can update karaoke jockey profiles through the client.
     * @deny (delete) No one can delete karaoke jockey profiles through the client.
     * @principle Only allow getting karaoke jockey profiles; creation, update, and deletion are restricted.
     */
    match /karaoke_jockeys/{karaokeJockeyId} {
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }
}